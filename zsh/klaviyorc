# === DOTFILES KLAVIYORC CONFIGURATION START - DO NOT EDIT MANUALLY ===

# Navigate without the cd cmd
setopt autocd

# Shows active AWS role: https://github.com/klaviyo/eng-handbook/blob/master/aws/saml2aws.md
[[ -z "${ZSH_VERSION:-}" ]] || setopt prompt_subst
alias aws_role='echo -ne "[$(grep ^x_principal_arn ~/.aws/credentials 2>/dev/null | cut -d/ -f2)] " | grep -E "^.{4,}$"'

export PS1='$(echo -ne "${S2A_AWS_ROLE:-$(aws_role)}")'"$PS1"
export PATH="$HOME/.klaviyocli/.bin:$PATH"

export KLAVIYO_REPOS_DIR=/Users/jarry.ngandjui/Klaviyo/Repos
export CHARIOT_SETTINGS=/Users/jarry.ngandjui/Klaviyo/Repos/k-repo/python/klaviyo/kms/config/settings/settings_development.py
export CURRENT_UID="$(id -u):$(id -g)"
export KL_SSH_USERNAME=jarryngandjui
export KL_LOCAL_MYSQL_ROOT_PASSWORD=jJO8iVhDC0ggw5NyYlEx
export KL_AWS_CUSTOM_S3_ENDPOINT=http://localhost:9000
export KL_LOCAL_DYNAMODB_ENDPOINT=http://localhost:4566
export KL_LOCAL_KMS_ENDPOINT=http://localhost:4566
export MAINLINE_PYTHON=/Users/jarry.ngandjui/.pyenv/versions/app/bin/python
export PANTS_CONCURRENT=True 
export PYENV_ROOT="$HOME/.pyenv"
export PATH="$PYENV_ROOT/bin:$PATH"

# Klaviyo CLI
alias k="klaviyocli"

# Klaviyo repos
alias krepo="cd $KLAVIYO_REPOS_DIR/k-repo"
alias app="cd $KLAVIYO_REPOS_DIR/app && pyenv activate app"
alias infra="cd $KLAVIYO_REPOS_DIR/infrastructure-deployment"
alias fender="cd $KLAVIYO_REPOS_DIR/fender"
alias handbook="cd $KLAVIYO_REPOS_DIR/eng-handbook"

# Pyenv
eval "$(pyenv init --path)"
eval "$(pyenv init -)"

# App files 
alias k-repo-pytest="PYTHONPATH=python pytest --asyncio-mode=auto"
source /Users/jarry.ngandjui/.apprc
source ~/.klaviyocli/.zshcompletions/_klaviyocli || true

function s2a-login {
    export SAML2AWS_CREDENTIALS_FILE=$(mktemp)
    saml2aws login --force --skip-prompt --cache-saml "$@" && {
        AWS_ROLE=$(grep ^x_principal_arn "${SAML2AWS_CREDENTIALS_FILE}" 2>/dev/null | cut -d/ -f2)
        source <(saml2aws script)
        export S2A_AWS_ROLE="[${AWS_ROLE}] "
    }
    rm -rf ${SAML2AWS_CREDENTIALS_FILE}
    unset SAML2AWS_CREDENTIALS_FILE
}


# Data Exchange Development 
# https://klaviyo.atlassian.net/wiki/spaces/EN/pages/4931649548/Event+Pipeline+2025+Local+Development

function dxe-preppub() {
  krepo
  LOG_LEVEL=info pants run python/klaviyo/data_exchange/prep_publisher/server:local
}

function dxe-broker() {
  app
  make pip-install
  make services-up
  # Create topics
  pants run python/klaviyo/data_exchange/event_pipeline_orchestrator/server/broker/kafka:create_topics
  echo "Kafka containers should now be running (check Docker Desktop for services-kafka-1)"
}

function dxe-orchestrator() {
  krepo
  [ -f requirements.txt ] && pip install -r requirements.txt
  LOG_LEVEL=info pants run python/klaviyo/data_exchange/event_pipeline_orchestrator/server:local
}

function dxe-processor() {
  app
  bin/django data_exchange event_pipeline_orchestrator_runner
}
# === DOTFILES KLAVIYORC CONFIGURATION END - DO NOT EDIT MANUALLY ===
